---
id: haproxy_spoa
title: HAProxy SPOA
sidebar_position: 10
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import useBaseUrl from '@docusaurus/useBaseUrl';
import RemediationSupportBadges from '@site/src/components/RemediationSupportBadges.tsx';

<p align="center">
<img src={useBaseUrl('/img/crowdsec_haproxy.svg')} alt="CrowdSec" title="CrowdSec" width="400" height="300" />
</p>
<p align="center">
<img src="https://img.shields.io/badge/build-pass-green" />
<img src="https://img.shields.io/badge/tests-pass-green" />
</p>
<p align="center">
&#x1F4DA; <a href="#installation/">Documentation</a>
&#x1F4A0; <a href="https://hub.crowdsec.net">Hub</a>
&#128172; <a href="https://discourse.crowdsec.net">Discourse </a>
</p>

<RemediationSupportBadges
  Appsec={false}
  Metrics
  Prometheus
/>


# A Remediation Component for haproxy.


## How does it work ?

The `cs-haproxy-spoa-bouncer` allows CrowdSec to enforce blocking, CAPTCHA, or
allow actions directly within HAProxy using the [SPOE
protocol](https://www.haproxy.com/blog/extending-haproxy-with-the-stream-processing-offload-engine).

It supports IP-based decisions, CAPTCHA challenges, GeoIP-based headers, and
integrates cleanly with CrowdSecâ€™s LAPI using the stream bouncer protocol.

Supported features:

 - Stream mode (pull the local API for new/old decisions every X seconds)
 - Ban remediation (can ban an IP address by redirecting or returning a custom HTML page)
 - Captcha remediation (can return a captcha)
 - Works with IPv4/IPv6
 - Support IP ranges (can apply a remediation on an IP range)


## Installation

We strongly encourage the use of our packages.

### Using packages

You will have to setup crowdsec repositories first [setup crowdsec
repositories](/docs/next/getting_started/install_crowdsec#install-our-repositories).

<Tabs
  defaultValue="haproxy_debian"
  values={[
    { label: 'Debian/Ubuntu', value: 'haproxy_debian' ,},
    { label: 'RHEL/Centos/Fedora', value: 'haproxy_rhel' ,},
  ]
}>
<TabItem value="haproxy_debian">

```bash
sudo apt install crowdsec-haproxy-spoa-bouncer
```

</TabItem>

<TabItem value="haproxy_rhel">

```bash
sudo dnf install crowdsec-haproxy-spoa-bouncer
```

</TabItem>

</Tabs>



### Manual installation

#### Compile the Binary

This requires a whole working [golang installation](https://go.dev/doc/install).

```bash
git clone https://github.com/crowdsecurity/crowdsec-spoa-bouncer.git
cd crowdsec-spoa-bouncer
make build
```

#### Configure the Bouncer
                                                     
```bash                                              
sudo mkdir -p /etc/crowdsec/bouncers/
sudo cp config/crowdsec-spoa-bouncer.yaml /etc/crowdsec/bouncers/                                         
```                                      

Edit `/etc/crowdsec/bouncers/crowdsec-spoa-bouncer.yaml`:

- Set your **LAPI URL** to point to your CrowdSec LAPI instance:
  ```yaml
  api_url: http://127.0.0.1:8080/
  ```

- Generate an API key on the server where CrowdSec is intalled:
  ```bash
  cscli bouncers add haproxy-spoa
  ```

- Paste the key into:
  ```yaml
  api_key: your-generated-key
  ```

Create runtime socket directory and crowdsec-spoa user:

```bash
sudo
sudo mkdir -p /run/crowdsec-spoa
sudo chown crowdsec-spoa:crowdsec-spoa /run/crowdsec-spoa
```

#### Configure HAProxy

##### Lua Integration & Environment Variables

In the `global` section of your `haproxy.cfg`, configure Lua paths and template environment:

```haproxy
global
    lua-prepend-path /usr/lib/crowdsec-haproxy-spoa-bouncer/lua/?.lua
    lua-load /usr/lib/crowdsec-haproxy-spoa-bouncer/lua/crowdsec.lua

    setenv CROWDSEC_BAN_TEMPLATE_PATH /var/lib/crowdsec/lua/haproxy/templates/ban.html
    setenv CROWDSEC_CAPTCHA_TEMPLATE_PATH /var/lib/crowdsec/lua/haproxy/templates/captcha.html
```

> These variables are used by the Lua module to render proper HTML responses for banned or captcha-validated users.

##### Add SPOE Filter in `frontend`

```haproxy
frontend test
    mode http
    bind *:9090

    filter spoe engine crowdsec config /etc/haproxy/crowdsec.cfg

    http-request set-header X-CrowdSec-Remediation %[var(txn.crowdsec.remediation)] if { var(txn.crowdsec.remediation) -m found }
    http-request set-header X-CrowdSec-IsoCode %[var(txn.crowdsec.isocode)] if { var(txn.crowdsec.isocode) -m found }
    http-request lua.crowdsec_handle if { var(txn.crowdsec.remediation) -m found }

    use_backend test_backend
```

##### Create SPOE Config

Create `/etc/haproxy/crowdsec.cfg`:


```haproxy
spoe-agent crowdsec-agent
    messages    crowdsec-ip crowdsec-http
    option      var-prefix      crowdsec
    option      set-on-error    error
    timeout     hello           100ms
    timeout     idle            30s
    timeout     processing      500ms
    use-backend crowdsec-spoa

spoe-message crowdsec-ip
    args id=unique-id src-ip=src src-port=src_port
    event on-client-session

spoe-message crowdsec-http
    args remediation=var(txn.crowdsec.remediation) crowdsec_captcha_cookie=req.cook(crowdsec_captcha_cookie) id=unique-id host=hdr(Host) method=method path=path query=query version=req.ver headers=req.hdrs body=re
q.body url=url ssl=ssl_fc
    event on-frontend-http-request
```

##### Add SPOE Backend

```haproxy
backend crowdsec-spoa
    mode tcp
    balance roundrobin
    server s1 127.0.0.1:9000
```

#### Modify HAProxy systemd Unit (Optional)

Edit `/etc/systemd/system/haproxy.service` and add:

```ini
[Service]
Environment=CROWDSEC_BAN_TEMPLATE_PATH=/var/lib/crowdsec/lua/haproxy/templates/ban.html
Environment=CROWDSEC_CAPTCHA_TEMPLATE_PATH=/var/lib/crowdsec/lua/haproxy/templates/captcha.html
```

Then reload systemd:

```bash
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
```

Then reload systemd:

```bash
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
```

#### Start the Bouncer

Run Directly

```bash
sudo ./crowdsec-spoa-bouncer -c /etc/crowdsec/bouncers/crowdsec-spoa-bouncer.yaml
```

Or Run as a Systemd Service

```bash
sudo cp config/crowdsec-spoa-bouncer.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable --now crowdsec-spoa-bouncer
```

## Configuration

Create or edit the configuration file at `/etc/crowdsec/bouncer/crowdsec-spoa-bouncer.yaml`:
```yaml
log_mode: file
log_dir: /var/log/
log_level: info
log_compression: true
log_max_size: 100
log_max_backups: 3
log_max_age: 30

update_frequency: 10s
api_url: http://127.0.0.1:8080/
api_key: ${API_KEY}
insecure_skip_verify: false

workers:
  - name: spoa1
    listen_addr: 0.0.0.0:9000
    listen_socket: /run/crowdsec-spoa/spoa-1.sock

worker_user: crowdsec-spoa
worker_group: crowdsec-spoa

asn_database_path: /var/lib/crowdsec/data/GeoLite2-ASN.mmdb
city_database_path: /var/lib/crowdsec/data/GeoLite2-City.mmdb

admin_socket: /run/crowdsec-spoa-admin.sock

prometheus:
  enabled: true
  listen_addr: 127.0.0.1
  listen_port: 60601
```

If you installed this bouncer through package, you should already have a working
configuration file.

You can get a workable configuration by using the yaml above and getting and api key by:
```bash
sudo cscli bouncers add mybouncer
API key for 'bouncertest':

   JdVa7DKBM35gPDAR014pH/55l38fxLGt02NPPnZgLQI

Please keep this key since you will not be able to retrieve it!
```

## HAProxy Configuration

### SPOE Filter

Add a SPOE agent configuration to /etc/haproxy/crowdsec.cfg:

```
[crowdsec]
spoe-agent crowdsec-agent
    messages    crowdsec-ip crowdsec-http

    option      var-prefix      crowdsec
    option      set-on-error    error
    timeout     hello           100ms
    timeout     idle            30s
    timeout     processing      500ms
    use-backend crowdsec-spoa
    log         global

## This message is used to customise the remediation from crowdsec-ip based on the host header
spoe-message crowdsec-http
    args remediation=var(txn.crowdsec.remediation) crowdsec_captcha_cookie=req.cook(crowdsec_captcha_cookie) id=unique-id host=hdr(Host) method=method path=path query=query version=req.ver headers=req.hdrs body=req.body url=url ssl=ssl_fc
    event on-frontend-http-request

## This message should be the first to trigger in the chain
spoe-message crowdsec-ip
    args id=unique-id src-ip=src src-port=src_port
    event on-client-session

```

If you installed the haproxy spoe bouncer through package, you will find this
configuration file in `/usr/share/docs/crowdsec-haproxy-spoa-bouncer/examples`

This crowdsec spoe agent configuration is then referenced in the main haproxy configuration file.

```
frontend http-in
    bind *:80
    filter spoe engine crowdsec config /etc/haproxy/crowdsec.cfg
    http-request set-header X-CrowdSec-Remediation %[var(txn.crowdsec.remediation)]
    http-request lua.crowdsec_handle if { var(txn.crowdsec.remediation) -m found }
    use_backend <whatever>

backend crowdsec-spoa
    mode tcp
    server s1 127.0.0.1:9000

```
This snippet can also be found in `/usr/share/docs/crowdsec-haproxy-spoa-bouncer/examples/haproxy.cfg`.

### Specific features

#### To enable CAPTCHA for a domain:

```
hosts:
  - host: "example.com"
    captcha:
      site_key: "<your-site-key>"
      secret_key: "<your-secret-key>"
      provider: "hcaptcha"
```

The following captcha providers are supported:
```
hcaptcha
recaptcha
turnstile
```

### Prometheus Metrics

Enable and expose metrics:

```
prometheus:
  enabled: true
  listen_addr: 127.0.0.1
  listen_port: 60601
```

Access them at http://127.0.0.1:60601/metrics.

### Admin Socket (to be tested)

You can query the bouncer runtime state using the admin socket:

socat - UNIX-CONNECT:/run/crowdsec-spoa-admin.sock

Commands:
```
    get hosts
    get host <host> session <uuid> <key>
    set host <host> session <uuid> <key> <value>
    get ip <ip>
    val host <host> cookie <cookie>
    val host <host> captcha <response>
```
